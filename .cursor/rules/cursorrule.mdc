---
alwaysApply: true
---
@description
B·ªô quy t·∫Øc ph√°t tri·ªÉn ·ª©ng d·ª•ng React Native + Expo cho d·ª± √°n "B√°c sƒ© L√∫a". 
M·ª•c ti√™u: ƒë·∫£m b·∫£o project c√≥ c·∫•u tr√∫c chu·∫©n (/src), hi·ªáu nƒÉng t·ªëi ∆∞u tr√™n Android, qu·∫£n l√Ω i18n chu·∫©n, quy·ªÅn runtime r√µ r√†ng, flow ch·ª•p ·∫£nh + watermark th√¥ng qua backend, v√† backend Node.js + MongoDB nh·∫π, ·ªïn ƒë·ªãnh, c√≥ Swagger v√† c∆° ch·∫ø wake-on-sleep cho Render. 
@end

@context
Ng√¥n ng·ªØ: TypeScript (∆∞u ti√™n) / JavaScript (h√†ng ph·ª•)
Framework: Expo Managed Workflow (create-expo-app)
M·ª•c ti√™u tri·ªÉn khai: Android-first t·ªëi ∆∞u, t∆∞∆°ng th√≠ch iOS, code c√≥ th·ªÉ scale, d·ªÖ maintain, CI-friendly, documentation lu√¥n c·∫≠p nh·∫≠t.
@end

@rules
{
  "always": {
    "description": "Nh·ªØng quy t·∫Øc b·∫Øt bu·ªôc to√†n c·ª•c.",
    "rules": [
       "Tr∆∞·ªõc khi CH·∫†Y CODE: lu√¥n h·ªèi user x√°c nh·∫≠n r√µ r√†ng nh·ªØng c√¢u h·ªèi b·∫°n ch∆∞a hi·ªÉu (v√≠ d·ª•: 'T√¥i c·∫ßn l√†m r√µ v·∫•n ƒë·ªÅ abc n√†y v√† t√¥i g·ª£i √Ω d√πng ph∆∞∆°ng √°n n√†y, b·∫°n c√≥ ƒë·ªìng √Ω kh√¥ng?').",
       "Tr∆∞·ªõc khi XO√Å ho·∫∑c CH·ªàNH S·ª¨A d·ªØ li·ªáu: lu√¥n h·ªèi x√°c nh·∫≠n v·ªõi user tr∆∞·ªõc khi th·ª±c hi·ªán, v√† hi·ªÉn th·ªã t√≥m t·∫Øt d·ªØ li·ªáu s·∫Ω b·ªã ·∫£nh h∆∞·ªüng n·∫øu c√≥ th·ªÉ.",
       "SAU M·ªñI L·∫¶N user g·ª≠i y√™u c·∫ßu: tr∆∞·ªõc khi th·ª±c hi·ªán h√†nh ƒë·ªông ch√≠nh ƒë∆∞·ª£c y√™u c·∫ßu, lu√¥n x√°c nh·∫≠n l·∫°i r·∫±ng h√†nh ƒë·ªông ƒë√≥ ƒë√∫ng v·ªõi √Ω ƒë·ªãnh c·ªßa user.",
      "Lu√¥n d√πng TypeScript cho business logic; file UI c√≥ th·ªÉ l√† .tsx. N·∫øu d√πng JS, ph·∫£i c√≥ JSDoc cho m·ªçi function export.",
      "Project root ph·∫£i c√≥ file `.env-example` ch·ª©a t·∫•t c·∫£ bi·∫øn m√¥i tr∆∞·ªùng d√πng trong app v√† backend (v√≠ d·ª•: API_URL, GOOGLE_CLIENT_ID, FACEBOOK_APP_ID, SENTRY_DSN n·∫øu d√πng). Kh√¥ng commit `.env` th·∫≠t v√†o VCS.",
      "Kh√¥ng ƒë·ªÉ `console.log`, `debugger` trong b·∫£n build production; d√πng logger controllable (v√≠ d·ª• `debug` ho·∫∑c Sentry) v√† t·∫Øt theo bi·∫øn m√¥i tr∆∞·ªùng.",
      "M·ªçi API network call ph·∫£i th√¥ng qua module ri√™ng `/src/services/api.ts` v√† s·ª≠ d·ª•ng axios instance c√≥ timeout, retry logic (3 l·∫ßn), v√† cancel token support."
    ]
  },

  "projectStructure": {
    "description": "C·∫•u tr√∫c Hybrid v·ªõi Expo Router + /src cho business logic.",
    "rules": [
      "Root ch·ª©a: /app (Expo Router screens), /src (business logic), v√† c√°c file c·∫•u h√¨nh (package.json, app.json, tsconfig.json, .eslintrc, .prettierrc, .env-example)",
      "C·∫•u tr√∫c Hybrid:",
      "  /app - Expo Router screens (file-based routing): (tabs), modal, _layout.tsx. Screens ch·ªâ ch·ª©a UI layout v√† import logic t·ª´ /src",
      "  /src/components - c√°c component t√°i s·ª≠ d·ª•ng (Header, Button, Modal, Avatar, WatermarkPreview, SkeletonLoader, etc.)",
      "  /src/hooks - custom hooks (useAuth, usePermissions, useI18n, useCameraFlow, useFetch)",
      "  /src/services - api clients, auth service, storage service",
      "  /src/constants - colors, spacing, fonts, keys",
      "  /src/i18n - c·∫•u h√¨nh i18n v√† files locales (vi.json, en.json)",
      "  /src/utils - helper functions, formatters, validators",
      "  /src/types - TypeScript types v√† interfaces global",
      "  /src/assets - h√¨nh, icon, fonts (t·ªëi ∆∞u k√≠ch th∆∞·ªõc & webp n·∫øu ph√π h·ª£p)",
      "Import xuy√™n folder ph·∫£i d√πng path aliases (v√≠ d·ª•: @/components, @/hooks, @/services) ƒë∆∞·ª£c c·∫•u h√¨nh trong tsconfig.json. Kh√¥ng d√πng nhi·ªÅu `../../..`.",
      "Screens trong /app KH√îNG ch·ª©a business logic - ch·ªâ import hooks/components t·ª´ /src v√† render UI."
    ]
  },

  "appJsonAndBuild": {
    "description": "C·∫•u h√¨nh app.json ƒë·ªÉ t√™n hi·ªÉn th·ªã l√† \"B√°c sƒ© L√∫a\" v√† build t·ªëi ∆∞u.",
    "rules": [
      "app.json / app.config.js ph·∫£i ƒë·∫∑t `name` v√† `displayName` ph√π h·ª£p: displayName = \"B√°c sƒ© L√∫a\".",
      "S·ª≠ d·ª•ng `expo-asset` v√† `expo-font` ƒë·ªÉ preload assets v√† fonts tr∆∞·ªõc khi show root screen.",
      "D√πng `eas build` cho production; c·∫•u h√¨nh eas.json ƒë·ªÉ c√≥ profile 'production' v√† 'development'.",
      "Prioritize minimal bundle: only install packages c·∫ßn thi·∫øt, tr√°nh native modules kh√¥ng h·ªó tr·ª£ Expo Managed Workflow.",
      "Ki·ªÉm tra v√† test `expo start --clear` tr∆∞·ªõc khi build release.",
      "ƒê·ªãnh nghƒ©a App version v√† buildNumber trong app.json v√† c·∫≠p nh·∫≠t m·ªói release."
    ]
  },

  "authAndAccounts": {
    "description": "ƒêƒÉng nh·∫≠p/ƒêƒÉng k√Ω qua email, s·ªë ƒëi·ªán tho·∫°i, Google, Facebook.",
    "rules": [
      "X√¢y module auth t·∫°i `/src/services/auth` x·ª≠ l√Ω: login, register, socialLogin, refreshToken, logout.",
      "Email/password v√† phone/SMS OTP ƒë·ªÅu ph·∫£i x√°c th·ª±c tr√™n backend. Tr√™n app: validate form tr∆∞·ªõc khi g·ª≠i (email regex, phone format).",
      "Social login (Google, Facebook) s·ª≠ d·ª•ng `expo-auth-session` ho·∫∑c SDK t∆∞∆°ng th√≠ch Expo; token exchange ph·∫£i th·ª±c hi·ªán an to√†n qua backend (backend verify token v·ªõi Google/Facebook v√† tr·∫£ JWT c·ªßa h·ªá th·ªëng).",
      "Kh√¥ng l∆∞u m·∫≠t kh·∫©u ·ªü client. L∆∞u token/refreshToken trong SecureStore (Expo SecureStore) ho·∫∑c encrypted storage.",
      "Th√™m flow must_change_password, forgot password v√† verify phone flow (OTP)."
    ]
  },

  "permissionsAndPrivacy": {
    "description": "Quy t·∫Øc x·ª≠ l√Ω quy·ªÅn runtime v√† privacy.",
    "rules": [
      "Khi app l·∫ßn ƒë·∫ßu ch·∫°y, show permission rationale UI r√µ r√†ng tr∆∞·ªõc khi g·ªçi requestPermissions (camera, location).",
      "ƒê·ªÅ xu·∫•t quy·ªÅn: CAMERA v√† LOCATION (coarse/fine) ‚Äî ch·ªâ request khi user c·∫ßn t√≠nh nƒÉng t∆∞∆°ng ·ª©ng (kh√¥ng request c√πng l√∫c n·∫øu ch∆∞a d√πng).",
      "D√πng `expo-permissions` / `expo-location` / `expo-camera` ƒë·ªÉ ki·ªÉm tra & request quy·ªÅn.",
      "Lu√¥n show fallback UI (explain how to enable in settings) n·∫øu user t·ª´ ch·ªëi quy·ªÅn.",
      "T·∫•t c·∫£ quy·ªÅn c·∫ßn ph·∫£i ƒë∆∞·ª£c khai b√°o r√µ r√†ng trong Privacy Policy (link trong app).",
      "Kh√¥ng request quy·ªÅn background location ho·∫∑c camera ch·∫°y n·ªÅn tr·ª´ khi c√≥ l√Ω do ch√≠nh ƒë√°ng v√† m√¥ t·∫£ r√µ trong store listing."
    ]
  },

  "cameraAndWatermarkFlow": {
    "description": "Flow m·ªü camera, ch·ª•p ·∫£nh, g·ª≠i backend ƒë·ªÉ g√°n watermark d·ª±a tr√™n ƒë·ªãnh v·ªã, l∆∞u ·∫£nh.",
    "rules": [
      "T·∫°o hook `useCameraFlow` ch·ªãu tr√°ch nhi·ªám: ki·ªÉm tra quy·ªÅn, m·ªü camera, capture, preview, send to API.",
      "·∫¢nh ch·ªâ ƒë∆∞·ª£c l∆∞u local sau khi backend tr·∫£ v·ªÅ ·∫£nh ƒë√£ g√°n watermark (backend s·∫Ω tr·∫£ URL ho·∫∑c base64).",
      "T·∫•t c·∫£ ·∫£nh upload ph·∫£i c√≥ metadata k√®m theo: { userId, timestamp, lat, lng, deviceId, orientation }. Metadata ph·∫£i ƒë∆∞·ª£c t·∫°o b·∫±ng location l·∫•y ngay tr∆∞·ªõc khi ch·ª•p (ho·∫∑c sau ch·ª•p tr∆∞·ªõc khi g·ª≠i).",
      "Kh√¥ng g·∫Øn watermark local ‚Äî watermark ph·∫£i ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi backend ƒë·ªÉ ƒë·∫£m b·∫£o nh·∫•t qu√°n (theo y√™u c·∫ßu).",
      "K√≠ch th∆∞·ªõc ·∫£nh tr∆∞·ªõc khi upload: resize/crop ph√≠a client ƒë·ªÉ ti·∫øt ki·ªám bƒÉng th√¥ng (v√≠ d·ª• max width 1280) nh∆∞ng gi·ªØ ƒë·ªß ch·∫•t l∆∞·ª£ng cho watermark. D√πng th∆∞ vi·ªán nh∆∞ `expo-image-manipulator`.",
      "Upload l√† multipart/form-data v√† backend c·∫ßn x√°c th·ª±c user token (Bearer).",
      "Tr√™n m√†n h√¨nh preview show progress upload v√† l√™n skeleton trong khi ch·ªù backend tr·∫£ ·∫£nh ƒë√£ watermark.",
      "N·∫øu backend tr·∫£ l·ªói ‚Äî show retry v·ªõi exponential backoff (max 3 attempts) v√† log l·ªói ·ªü service layer."
    ]
  },

  "i18n": {
    "description": "Thi·∫øt l·∫≠p i18n (Ti·∫øng Vi·ªát m·∫∑c ƒë·ªãnh) v√† lu√¥n c·∫≠p nh·∫≠t khi code thay ƒë·ªïi.",
    "rules": [
      "D√πng `i18next` + `react-i18next` + `expo-localization`.",
      "Locale files n·∫±m ·ªü `/src/i18n/locales/vi.json` v√† `/src/i18n/locales/en.json`.",
      "Default language = 'vi'. H·ªó tr·ª£ chuy·ªÉn ƒë·ªïi trong settings v√† l∆∞u `appLanguage` v√†o AsyncStorage.",
      "T·∫•t c·∫£ text render ph·∫£i th√¥ng qua `t('key')`. Kh√¥ng hardcode string.",
      "Khi th√™m/x√≥a key i18n ‚Äî c·∫≠p nh·∫≠t `AppLogicConfig.Md` v√† ch·∫°y script ki·ªÉm tra (node script) ƒë·ªÉ ph√°t hi·ªán key missing (CI job).",
      "Khi deploy code m·ªõi, CI pipeline ph·∫£i ch·∫°y `i18n-check` script ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng m·∫•t key d·ªãch ‚Äî n·∫øu m·∫•t key, build fail.",
      "Th·ª±c hi·ªán fallbackLng = 'vi' v√† logging c·∫£nh b√°o khi thi·∫øu key trong dev."
    ]
  },

  "skeleton": {
    "description": "Skeleton UI cho loading m∆∞·ª£t m√†.",
    "rules": [
      "Skeleton components n·∫±m trong `/src/components/skeletons`. M·ªói screen c√≥ th·ªÉ c√≥ Skeleton component ri√™ng (v√≠ d·ª•: HomeScreenSkeleton, CameraScreenSkeleton).",
      "D√πng th∆∞ vi·ªán `moti` ho·∫∑c `react-native-reanimated` ƒë·ªÉ t·∫°o shimmer/fade nh·∫π cho skeleton animation.",
      "Skeleton ch·ªâ hi·ªÉn th·ªã khi `isLoading === true`. Kh√¥ng g·ªçi API khi ƒëang show skeleton (data fetch tr∆∞·ªõc/sau qu·∫£n l√Ω ·ªü screen).",
      "Skeleton components ph·∫£i memoized (React.memo/useMemo).",
      "Kh√¥ng ƒë·ªÉ skeleton t·ªìn t·∫°i qu√° l√¢u ‚Äî n·∫øu > 3s hi·ªÉn th·ªã retry ho·∫∑c error placeholder.",
      "Kh√¥ng l·ªìng skeleton trong FlatList ‚Äî d√πng SkeletonItem cho t·ª´ng ph·∫ßn t·ª≠."
    ]
  },

  "performance": {
    "description": "T·ªëi ∆∞u t·ªëc ƒë·ªô load app v√† runtime.",
    "rules": [
      "Preload fonts v√† critical assets tr∆∞·ªõc khi mount AppRoot (show minimal splash).",
      "T√°ch bundle b·∫±ng dynamic imports cho c√°c screens hi·∫øm d√πng (React.lazy / dynamic import).",
      "S·ª≠ d·ª•ng `expo-updates` ƒë·ªÉ cung c·∫•p patch nh·∫π (ch·ªâ khi tu√¢n th·ªß policy).",
      "S·ª≠ d·ª•ng `expo-image` ho·∫∑c `react-native-fast-image` (n·∫øu s·ª≠ d·ª•ng bare) ƒë·ªÉ t·ªëi ∆∞u h√¨nh ·∫£nh.",
      "Gi·∫£m s·ªë l∆∞·ª£ng re-render: d√πng useCallback, useMemo, React.memo, keyExtractor tr√™n FlatList.",
      "Gi·ªõi h·∫°n s·ªë permission requests v√† heavy native modules kh·ªüi t·∫°o l√∫c cold start."
    ]
  },

  "backendRequirements": {
    "description": "Y√™u c·∫ßu backend (Node.js + MongoDB) v√† c√°ch deploy tr√™n Render.",
    "rules": [
      "Backend d√πng Node.js (TS recommended) + Express (ho·∫∑c Fastify cho performance) + Mongoose cho MongoDB.",
      "C∆° s·ªü d·ªØ li·ªáu: MongoDB Atlas (ho·∫∑c self-host); collections t·ªëi thi·ªÉu: `users`, `photos`, `sessions`.",
      "Collection `users` ch·ª©a: { _id, email, phone, passwordHash, displayName, socialIds, roles, createdAt, updatedAt }.",
      "Collection `photos` ch·ª©a: { _id, userId, originalUrl, watermarkedUrl, metadata: { lat, lng, timestamp, device }, status, createdAt }.",
      "Endpoints c∆° b·∫£n: /auth/register, /auth/login, /auth/social, /auth/refresh, /photos/upload, /photos/{id}, /photos/list, /health, /swagger.json.",
      "S·ª≠ d·ª•ng JWT cho auth, refresh token l∆∞u an to√†n (db). HTTPS b·∫Øt bu·ªôc (Render cung c·∫•p SSL).",
      "Build API ph·∫£i expose Swagger UI (v√≠ d·ª• `/api/docs` ho·∫∑c `/swagger`) ƒë·ªÉ qu·∫£n l√Ω v√† test endpoints.",
      "T·∫°o file `.env-example` ch·ª©a bi·∫øn: PORT, MONGO_URI, JWT_SECRET, JWT_EXPIRES, RENDER_INTERNAL_URL (n·∫øu c·∫ßn), GOOGLE_CLIENT_ID, FACEBOOK_APP_SECRET, CRON_SECRET.",
      "V√¨ Render c√≥ th·ªÉ sleep ‚Äî tri·ªÉn khai cron/ping b·∫±ng `node-cron` ho·∫∑c `cron` ƒë·ªÉ ping internal health endpoint m·ªói 2‚Äì3 ph√∫t. T·ª©c: cron job server t·ª± ping ho·∫∑c s·ª≠ d·ª•ng external uptime service; ph·∫£i b·∫£o v·ªá b·∫±ng CRON_SECRET ƒë·ªÉ tr√°nh abuse.",
      "T·ªëi ∆∞u nh·∫π: b·∫≠t gzip compression, set cache headers cho assets tƒ©nh, stream uploads n·∫øu c·∫ßn."
    ]
  },

  "renderAndCronWake": {
    "description": "C√°ch ch·ªØa Render sleep.",
    "rules": [
      "Trong app backend, t·∫°o route `/health` tr·∫£ 200 simple JSON.",
      "C·∫•u h√¨nh cron job trong backend (node-cron) ƒë·ªÉ m·ªói 2 ph√∫t th·ª±c hi·ªán fetch GET `/health` n·∫øu Render account kh√¥ng cho external uptime. (L∆∞u √Ω: ping n·ªôi b·ªô n√†y h·ªØu d·ª•ng nh∆∞ng kh√¥ng n√™n l·∫°m d·ª•ng; n·∫øu d√πng external uptime service ‚Äî an to√†n h∆°n).",
      "B·∫£o v·ªá cron ping b·∫±ng token (CRON_SECRET) ho·∫∑c ch·ªâ ping t·ª´ internal worker process.",
      "Log cron wake attempts nh·∫π ƒë·ªÉ debug, nh∆∞ng kh√¥ng spam logs."
    ]
  },

  "swaggerAndDocs": {
    "description": "API documentation & dev UX.",
    "rules": [
      "Bao g·ªìm Swagger (OpenAPI 3) auto-generated t·ª´ code (v√≠ d·ª• swagger-jsdoc ho·∫∑c tsoa) v√† hi·ªÉn th·ªã UI t·∫°i `/api/docs`.",
      "M·ªçi endpoint m·ªõi ph·∫£i ƒë∆∞·ª£c document trong Swagger; CI job ki·ªÉm tra coverage c·ªßa docs (v√≠ d·ª• ki·ªÉm tra n·∫øu route kh√¥ng c√≥ OpenAPI doc ‚Üí fail build).",
      "Update `BackendConfig.Md` m·ªói khi thay ƒë·ªïi schema, endpoint, ho·∫∑c authentication flow."
    ]
  },

  "ciAndReleaseFlow": {
    "description": "CI, pre-deploy checks v√† release checklist.",
    "rules": [
      "CI pipeline (GitHub Actions/GitLab CI) ph·∫£i ch·∫°y: lint, typecheck, i18n-check, unit tests, expo-doctor (for app), node tests (for backend).",
      "Pre-release checklist: permissions, privacy policy link, icon & splash, app.json, version bump, BackendConfig.Md & AppLogicConfig.Md updated.",
      "Build artifact size n√™n b·ªã c·∫£nh b√°o n·∫øu v∆∞·ª£t threshold (configurable)."
    ]
  },

  "docsAndUpdating": {
    "description": "Quy t·∫Øc c·∫≠p nh·∫≠t hai file docs auto/manual.",
    "rules": [
      "AppLogicConfig.Md ph·∫£i m√¥ t·∫£: c·∫•u tr√∫c /app v√† /src, Expo Router file-based routing, screen list trong /app, i18n keys quan tr·ªçng, camera+watermark flow, permission flow, path aliases, v√† environment variables used in app.",
      "BackendConfig.Md ph·∫£i m√¥ t·∫£: DB schemas (users, photos), endpoint list, auth flow, error codes, env vars, deployment notes (render + cron), swagger url, and sample requests/responses.",
      "M·ªói Pull Request l·ªõn ph·∫£i k√®m diff update cho c√°c file doc t∆∞∆°ng ·ª©ng (reviewers ki·ªÉm tra doc tr∆∞·ªõc merge).",
      "ƒê·∫∑t tag [DOCS] trong commit message khi ch·ªânh docs."
    ]
  },

  "expoRouter": {
    "description": "Quy t·∫Øc s·ª≠ d·ª•ng Expo Router (file-based routing).",
    "rules": [
      "S·ª≠ d·ª•ng Expo Router cho navigation - folder /app l√† entry point ch√≠nh.",
      "File-based routing: /app/index.tsx (home), /app/(tabs)/_layout.tsx (tab navigator), /app/modal.tsx (modal screen).",
      "D√πng expo-router hooks: useRouter(), useLocalSearchParams(), usePathname() cho navigation.",
      "Screens trong /app ch·ªâ ch·ª©a UI structure v√† import business logic t·ª´ /src/hooks v√† /src/services.",
      "Layouts (_layout.tsx) qu·∫£n l√Ω navigation structure (Stack, Tabs) v√† global providers.",
      "Typed routes ƒë∆∞·ª£c enable qua experiments.typedRoutes trong app.json."
    ]
  },

  "security": {
    "description": "B·∫£o m·∫≠t d·ªØ li·ªáu v√† best practices.",
    "rules": [
      "T·∫•t c·∫£ m·∫≠t kh·∫©u ph·∫£i hash tr√™n backend (bcrypt/argon2).",
      "Kh√¥ng g·ª≠i secrets trong logs ho·∫∑c client. Sentry/monitoring ph·∫£i t·∫Øt chi ti·∫øt stack traces ·ªü prod.",
      "Th·ª±c hi·ªán rate limiting cho endpoints nh·∫°y c·∫£m (login, OTP).",
      "D√πng HTTPS cho m·ªçi g·ªçi API; implement CORS whitelist cho web clients n·∫øu c·∫ßn.",
      "Th·ª±c hi·ªán validation v√† sanitization cho m·ªçi input (use celebrate/Joi ho·∫∑c Zod)."
    ]
  }
}
@end

@example
üìò V√≠ d·ª• `app.json` v·ªõi Expo Router:
```json
{
  "expo": {
    "name": "DoctorRice",
    "slug": "doctorrice",
    "displayName": "B√°c sƒ© L√∫a",
    "version": "1.0.0",
    "orientation": "portrait",
    "icon": "./src/assets/icon.png",
    "splash": {
      "image": "./src/assets/splash.png",
      "resizeMode": "contain",
      "backgroundColor": "#ffffff"
    },
    "android": {
      "package": "com.yourcompany.doctorrice",
      "adaptiveIcon": {
        "foregroundImage": "./src/assets/icon.png",
        "backgroundColor": "#ffffff"
      }
    },
    "plugins": ["expo-router"],
    "experiments": {
      "typedRoutes": true
    }
  }
}